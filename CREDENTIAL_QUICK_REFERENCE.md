# Database Credential Storage - Quick Reference

## For Developers

### Using Credentials in Your Scripts

**Old Way (File-Based):**
```python
from src.config import get_ga4_client

# Automatically used GA4_KEY_PATH from .env
client = get_ga4_client()
```

**New Way (Database-Backed):**
```python
from src.config import get_ga4_client

# Automatically uses database if USE_DATABASE_CREDENTIALS=true
# Falls back to file-based if database unavailable
client = get_ga4_client()
```

**No code changes required!** The `src/config.py` module handles everything transparently.

---

## Common Tasks

### Add a New Credential

```bash
# Run migration script with custom name
ddev exec bash -c "source .venv/bin/activate && python3 scripts/migrate_credentials_to_db.py \
  --file path/to/new-credential.json \
  --name 'My New Credential' \
  --type google_token"
```

### List Available Credentials

```python
from src.credential_manager import DatabaseCredentialManager

with DatabaseCredentialManager() as manager:
    for cred in manager.list_credentials():
        print(f"{cred['name']} ({cred['type']})")
```

Or via database:
```bash
ddev mysql -e "SELECT name, type, created_at FROM credentials WHERE is_active=1;" google-stats
```

### Retrieve a Credential

```python
from src.credential_manager import DatabaseCredentialManager

with DatabaseCredentialManager() as manager:
    # Get as dictionary
    cred_data = manager.get_credential("GA4 Service Account", "google_token")
    
    # Get as temporary file (for Google libraries)
    cred_path = manager.get_credential_as_temp_file("GA4 Service Account", "google_token")
```

### Test Database Credentials

```bash
ddev exec bash -c "source .venv/bin/activate && python3 scripts/test_db_credentials.py"
```

---

## Configuration

### Enable Database Credentials

Add to `.env`:
```env
USE_DATABASE_CREDENTIALS=true
```

### Disable Database Credentials (Use File-Based)

Change in `.env`:
```env
USE_DATABASE_CREDENTIALS=false
```

---

## Security

### Encryption Details
- **Algorithm:** AES-256 (Fernet symmetric encryption)
- **Key Storage:** `.env` file (gitignored)
- **Key Derivation:** PBKDF2-HMAC-SHA256 (100,000 iterations)
- **Backup:** Automatic before migration

### Best Practices
âœ… Never commit `.env` to git  
âœ… Keep encryption key secure  
âœ… Backup database regularly  
âœ… Rotate credentials periodically  
âœ… Monitor `security_events` table  

### Environment Variables
```env
# Required for database credentials
USE_DATABASE_CREDENTIALS=true
CREDENTIAL_ENCRYPTION_KEY=<auto-generated>

# Optional
CREDENTIAL_MASTER_PASSWORD=<your-password>
ENCRYPTION_SALT=<custom-salt>
```

---

## Troubleshooting

### "Credential not found in database"
**Solution:** Run migration script to import credential

### "No encryption key available"
**Solution:** Check `.env` for `CREDENTIAL_ENCRYPTION_KEY`

### "Failed to decrypt credential"
**Solution:** Verify encryption key matches what was used during migration

### Scripts fail to connect to database
**Solution:** Check database is running: `ddev mysql -e "SELECT 1;" google-stats`

---

## Files & Locations

| File | Purpose |
|------|---------|
| `src/credential_manager.py` | Credential retrieval library |
| `scripts/migrate_credentials_to_db.py` | Migration script |
| `scripts/test_db_credentials.py` | Test script |
| `backup/credentials/` | Credential backups |
| `/tmp/gs_cred_*.json` | Temporary credential files (auto-deleted) |

---

## Migration Commands

```bash
# Basic migration (removes plaintext file)
ddev exec bash -c "source .venv/bin/activate && \
  python3 scripts/migrate_credentials_to_db.py"

# Keep plaintext file (for testing)
ddev exec bash -c "source .venv/bin/activate && \
  python3 scripts/migrate_credentials_to_db.py --keep-file"

# Custom credential
ddev exec bash -c "source .venv/bin/activate && \
  python3 scripts/migrate_credentials_to_db.py \
  --file path/to/cred.json \
  --name 'Custom Name' \
  --type google_ads"
```

---

## Need Help?

- ðŸ“˜ **Full Guide:** [CREDENTIAL_MIGRATION_GUIDE.md](CREDENTIAL_MIGRATION_GUIDE.md)
- ðŸ“˜ **Complete Documentation:** [CREDENTIAL_ENCRYPTION_COMPLETE.md](CREDENTIAL_ENCRYPTION_COMPLETE.md)
- ðŸ“˜ **Architecture:** [AUTH_MIGRATION_COMPLETE.md](AUTH_MIGRATION_COMPLETE.md)

---

**Quick Start:**
1. Ensure `.env` has `USE_DATABASE_CREDENTIALS=true`
2. Your scripts work automatically - no code changes needed!
3. Credentials are encrypted in database, not stored as files
4. Temporary files auto-cleanup after use
