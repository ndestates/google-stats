# 2025-12-30 TODO

## ğŸ¯ Goals

1. [x] Finalize plan to generate GA4 audiences from catalog/XML feed listings and price ranges.

## ğŸ” Research & Inputs

1. [x] Locate catalog/XML feed endpoint or file path; document auth, format (XML/JSON), and sample fields (URL, price, status).
   - **Feed URL**: <https://api.ndestates.com/feeds/ndefeed.xml> (public, no auth required)
   - **Format**: XML with elements: `<property url="..." price="..." type="buy|rent" status="..." reference="..." propertyname="..."/>`
   - **Current Stats**: 39 buy listings available, distributed across price bands

2. [x] Confirm listing URL pattern and canonicalization rules (trailing slash, query params, locale subpaths); decide on dedupe logic.
   - **URL Pattern**: <https://www.ndestates.com/properties/{slug}> (no trailing slashes, clean URLs)
   - **Canonicalization**: URLs are already clean; no query params observed
   - **Dedupe Logic**: Using `reference` field (e.g., STH250129) as unique identifier + existing audience check

3. [x] Validate price field availability/units (GBP) and rounding rules to map listings into ranges (Â£200k-Â£400k, Â£400k-Â£600k, Â£600k-Â£800k, Â£800k-Â£1m, Â£1m+).
   - **Price Field**: Available for all listings (integer GBP values)
   - **Price Bands Confirmed**:
     - Â£200kâ€“Â£400k: 12 listings
     - Â£400kâ€“Â£600k: 10 listings
     - Â£600kâ€“Â£800k: 12 listings
     - Â£800kâ€“Â£1m: 2 listings
     - Â£1m+: 2 listings

4. [x] Check GA4 audience limits/quotas and naming conventions for per-listing audiences; define naming template e.g., "Listing - {slug}" and "Price Range - Â£X-Â£Y".
   - **Naming Template**: "[Listing] - {propertyname}" (e.g., "[Listing] - St Helier - One Bedroom Cottage in Town")
   - **Price Band Template**: "Price Range - Â£Xâ€“Â£Y" (e.g., "Price Range - Â£200kâ€“Â£400k")
   - **GA4 Limits**: 500 custom audiences per property (39 listings + 5 price bands = 44 audiences âœ… within limits)

## ğŸ“¦ Feed-driven audience mapping (from <https://api.ndestates.com/feeds/ndefeed.xml>)

1. [x] Parse feed fields: `url`, `price`, `type` (buy/rent), `status`, `reference`, `propertyname`; ignore unavailable listings.
   - **Implementation**: `parse_feed()` function in `scripts/audience_management.py` (lines 27â€“55)
   - **Status**: Only "available" listings are included

2. [x] Generate one page-view audience per available listing using `create_page_view_audience` with pageLocation `url`.
   - **Implementation**: `generate_audiences_from_feed()` function (lines 535â€“635)
   - **Naming Convention**: "[Listing] - {propertyname}" (e.g., "[Listing] - St Helier - One Bedroom Cottage in Town")
   - **Tested**: Dry-run verified 39 audiences would be created correctly

3. [x] Build price-band audiences (only `type=buy`, GBP): Â£200kâ€“Â£400k, Â£400kâ€“Â£600k, Â£600kâ€“Â£800k, Â£800kâ€“Â£1m, Â£1m+; include page paths for listings whose `price` falls in band; consider `type=rent` separately (skip or future bands).
   - **Implementation**: Uses `assign_price_band()` function and batch URL creation
   - **Tested**: Dry-run confirms 5 price-band audiences with correct listing counts

4. [x] Add dedupe/idempotency: skip audience create if already exists; cap batch size per run to avoid GA4 limits; expose `--limit` and `--dry-run` CLI flags.
   - **Implemented**: `list_existing_audience_names()` + existence check before create
   - **CLI Flags**: `--dry-run`, `--limit`, `--scope {listing|price-bands|both}` all present

5. [x] Handle URL canonicalization (trailing slash, query params) and ensure case-normalized matches; optionally store feed snapshot to `reports/feeds/` for auditing.

- **Status**: Feed URLs are already canonical; no additional processing needed

## ğŸ“ Implementation - COMPLETED âœ…

The `scripts/audience_management.py` script already includes:

- Feed fetching and parsing (`fetch_feed()`, `parse_feed()`)
- Listing audience generation with reference-based naming
- Price-band audience creation with proper filtering
- Idempotent audience creation (checks for duplicates)
- Full CLI support with `--dry-run`, `--limit`, `--scope`, and `--duration` flags

## ğŸ“Š Testing & Validation

1. [x] Run dry-run in DDEV (`ddev exec python3 scripts/audience_management.py ...`) to print would-be audiences and confirm naming/filters.

- **Result**: âœ… Dry-run successful
  - 39 listing audiences would be created
  - 5 price-band audiences would be created
  - Total: 44 audiences (within GA4 limits)
  - URL parsing working correctly

1. [ ] Execute a controlled create run against test property; verify audiences appear in GA4 Admin and that metrics populate after data accrues.

- **Status**: Pending (awaiting approval to create)
- **Command**: `ddev exec python3 scripts/audience_management.py --action generate-from-feed --scope both --limit 10`

1. [ ] Document steps and edge cases (missing prices, sold/hidden listings, duplicate URLs) in README or doc section.

- **Status**: Pending documentation
